services:
  # RustFS main service
  rustfs:
    image: ${RUSTFS_IMAGE:-rustfs/rustfs:latest}
    container_name: ${RUSTFS_CONTAINER_NAME:-rustfs-server}
    security_opt:
      - "no-new-privileges:true"
    ports:
      - "${RUSTFS_S3_PORT:-9000}:9000"
      - "${RUSTFS_CONSOLE_PORT:-9001}:9001"
      - "${RUSTFS_FTPS_PORT:-8021}:8021"
      - "${RUSTFS_SFTP_PORT:-8022}:8022"
      - "40000-41000:40000-41000"
    environment:
      - RUSTFS_VOLUMES=${RUSTFS_VOLUMES}
      - RUSTFS_ADDRESS=${RUSTFS_ADDRESS}
      - RUSTFS_CONSOLE_ADDRESS=${RUSTFS_CONSOLE_ADDRESS}
      - RUSTFS_CONSOLE_ENABLE=${RUSTFS_CONSOLE_ENABLE}
      - RUSTFS_EXTERNAL_ADDRESS=${RUSTFS_EXTERNAL_ADDRESS}
      - RUSTFS_CORS_ALLOWED_ORIGINS=${RUSTFS_CORS_ALLOWED_ORIGINS}
      - RUSTFS_CONSOLE_CORS_ALLOWED_ORIGINS=${RUSTFS_CONSOLE_CORS_ALLOWED_ORIGINS}
      - RUSTFS_ACCESS_KEY=${RUSTFS_ACCESS_KEY}
      - RUSTFS_SECRET_KEY=${RUSTFS_SECRET_KEY}
      - RUSTFS_OBS_LOGGER_LEVEL=${RUSTFS_OBS_LOGGER_LEVEL}
      - RUSTFS_TLS_PATH=${RUSTFS_TLS_PATH}
      - RUSTFS_OBJECT_CACHE_ENABLE=${RUSTFS_OBJECT_CACHE_ENABLE}
      - RUSTFS_OBJECT_CACHE_TTL_SECS=${RUSTFS_OBJECT_CACHE_TTL_SECS}
      # FTPS Configuration
      - RUSTFS_FTPS_ENABLE=${RUSTFS_FTPS_ENABLE}
      - RUSTFS_FTPS_ADDRESS=${RUSTFS_FTPS_ADDRESS}
      - RUSTFS_FTPS_CERTS_FILE=${RUSTFS_FTPS_CERTS_FILE}
      - RUSTFS_FTPS_KEY_FILE=${RUSTFS_FTPS_KEY_FILE}
      - RUSTFS_FTPS_PASSIVE_PORTS=${RUSTFS_FTPS_PASSIVE_PORTS}
      # SFTP Configuration
      - RUSTFS_SFTP_ENABLE=${RUSTFS_SFTP_ENABLE}
      - RUSTFS_SFTP_ADDRESS=${RUSTFS_SFTP_ADDRESS}
      - RUSTFS_SFTP_HOST_KEY=${RUSTFS_SFTP_HOST_KEY}
      - RUSTFS_SFTP_AUTHORIZED_KEYS=${RUSTFS_SFTP_AUTHORIZED_KEYS}
    volumes:
      - rustfs_data_0:/data/rustfs0
      - rustfs_data_1:/data/rustfs1
      - rustfs_data_2:/data/rustfs2
      - rustfs_data_3:/data/rustfs3
      - logs:/app/logs
      - ./tls:/opt/tls:ro
      - ./sftp:/opt/sftp:ro
    networks:
      - rustfs-network
    restart: unless-stopped
    depends_on:
      volume-permission-helper:
        condition: service_completed_successfully
    healthcheck:
      test:
        [
          "CMD",
          "sh",
          "-c",
          "curl -f http://localhost:9000/health && curl -f http://localhost:9001/rustfs/console/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # RustFS volume permissions fixer service
  volume-permission-helper:
    image: alpine
    volumes:
      - rustfs_data_0:/data0
      - rustfs_data_1:/data1
      - rustfs_data_2:/data2
      - rustfs_data_3:/data3
      - logs:/logs
    command: >
      sh -c "
        chown -R ${RUSTFS_USER_ID:-10001}:${RUSTFS_USER_ID:-10001} /data0 /data1 /data2 /data3 /logs &&
        echo 'Volume permissions fixed' &&
        exit 0
      "
    restart: "no"

networks:
  rustfs-network:

volumes:
  rustfs_data_0:
  rustfs_data_1:
  rustfs_data_2:
  rustfs_data_3:
  logs:
